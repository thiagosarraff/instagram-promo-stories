# üì± Instagram Stories Upload - FastAPI Automation

FastAPI application for Instagram Story automation. Accepts product data via HTTP POST and manages story creation and posting.

## üöÄ Quick Start

### 1. Install Dependencies

```bash
pip install -r requirements.txt
```

### 2. Configure Environment Variables

Copy `.env.example` to `.env`:

```bash
cp .env.example .env
```

Edit `.env` with your Instagram credentials:

```env
# Required
INSTAGRAM_USERNAME=your_instagram_username
INSTAGRAM_PASSWORD=your_instagram_password

# Optional (defaults shown)
API_PORT=5000
API_HOST=0.0.0.0
TEMPLATE_PATH=/app/templates
LOG_LEVEL=INFO
```

## Configuration

### Environment Variables

#### Required Settings

- **`INSTAGRAM_USERNAME`** - Your Instagram account username
- **`INSTAGRAM_PASSWORD`** - Your Instagram account password or app-specific password
  - If 2FA is enabled, use an Instagram app-specific password instead of your account password

#### Optional Settings (with defaults)

| Variable | Default | Description |
|----------|---------|-------------|
| `API_PORT` | `5000` | Port for the API server (1024-65535) |
| `API_HOST` | `0.0.0.0` | Host binding (0.0.0.0 = all interfaces, 127.0.0.1 = localhost only) |
| `TEMPLATE_PATH` | `/app/templates` | Path to story templates directory |
| `LOG_LEVEL` | `INFO` | Logging level (DEBUG, INFO, WARNING, ERROR, CRITICAL) |
| `REQUEST_TIMEOUT` | `120` | HTTP request timeout in seconds (10-600) |
| `INSTAGRAM_SESSION_PATH` | `/app/session` | Path for Instagram session storage |
| `MAX_CONCURRENT_REQUESTS` | `5` | Maximum concurrent story posts (1-20) |

### Local Development Setup

1. Copy template (if you have custom templates):
   ```bash
   mkdir -p templates
   ```

2. Run the application:
   ```bash
   python -m uvicorn app:app --reload
   ```

3. Check the health endpoint:
   ```bash
   curl http://localhost:5000/health
   ```

### Docker Deployment

#### Using Docker Compose

1. Create `.env` file with your configuration:
   ```bash
   cp .env.example .env
   # Edit .env with your credentials
   ```

2. Create directories for volumes:
   ```bash
   mkdir -p templates logs session
   ```

3. Start the service:
   ```bash
   docker-compose up -d
   ```

4. Check logs:
   ```bash
   docker-compose logs -f insta-stories
   ```

5. Stop the service:
   ```bash
   docker-compose down
   ```

#### Manual Docker Build

```bash
# Build image
docker build -t insta-stories:latest .

# Run container
docker run -d \
  --name insta-stories-api \
  -p 5000:5000 \
  -e INSTAGRAM_USERNAME=your_username \
  -e INSTAGRAM_PASSWORD=your_password \
  -v $(pwd)/templates:/app/templates:ro \
  -v $(pwd)/logs:/app/logs \
  -v $(pwd)/session:/app/session \
  insta-stories:latest
```

## API Endpoints

### Health Check
```bash
GET /health

# Response
{
  "status": "healthy",
  "timestamp": "2024-01-01T12:00:00.000000"
}
```

### Post Story
```bash
POST /post-story

# Request
{
  "product_name": "Product Name",
  "price": "R$ 99.90",
  "product_image_url": "https://example.com/image.jpg",
  "marketplace_name": "Marketplace Name",
  "affiliate_link": "https://affiliate.link",
  "template_scenario": 1
}

# Response (Success)
{
  "status": "success",
  "message": "Story posted successfully",
  "story_id": null,
  "error_code": null
}

# Response (Error)
{
  "status": "error",
  "message": "Error description",
  "error_code": "ERROR_CODE"
}
```

## Security Considerations

### Credentials Management

1. **Never commit `.env` file** - It's already in `.gitignore`
2. **Use app-specific passwords** - Instagram recommends app passwords for 2FA accounts
3. **Rotate credentials regularly** - Change password periodically
4. **Never log passwords** - The application masks passwords in logs

### Environment Variable Security

- In Docker, use `.env` file for local testing only
- In production (VPS), set environment variables directly in Docker/system configuration
- Never include credentials in docker-compose.yml or Dockerfile
- Use Docker secrets or secure environment variable management for production

### Example Production Setup (VPS)

```bash
# On VPS, set environment variables before running
export INSTAGRAM_USERNAME="your_username"
export INSTAGRAM_PASSWORD="your_password"

# Then run Docker compose
docker-compose up -d
```

Or in Docker secrets:
```bash
# Add to docker-compose.yml
services:
  insta-stories:
    environment:
      - INSTAGRAM_USERNAME_FILE=/run/secrets/ig_username
      - INSTAGRAM_PASSWORD_FILE=/run/secrets/ig_password
    secrets:
      - ig_username
      - ig_password

secrets:
  ig_username:
    external: true
  ig_password:
    external: true
```

## Troubleshooting

### Missing Configuration Error

If you see: "Instagram credentials in environment"

**Solution**: Make sure `.env` file exists and contains:
```env
INSTAGRAM_USERNAME=your_username
INSTAGRAM_PASSWORD=your_password
```

### Port Already in Use

If you see: "Address already in use" on port 5000

**Solution**: Either:
1. Kill the process using the port
2. Use a different port: `API_PORT=5001`

### Template Path Not Found

If you see: "Template path does not exist"

**Solution**: Create the templates directory:
```bash
mkdir -p templates
```

### Configuration Validation Failed

Make sure:
- `API_PORT` is between 1024 and 65535
- `LOG_LEVEL` is one of: DEBUG, INFO, WARNING, ERROR, CRITICAL
- `REQUEST_TIMEOUT` is between 10 and 600

## Testing Configuration

Test that configuration loads correctly:

```bash
# Test with Python
python -c "from config import settings; print(f'Config loaded: {settings.api_host}:{settings.api_port}')"

# Test API health
curl http://localhost:5000/health
```

## Project Structure

```
insta-stories/
‚îú‚îÄ‚îÄ app.py                      # FastAPI application
‚îú‚îÄ‚îÄ config.py                   # Configuration management
‚îú‚îÄ‚îÄ models.py                   # Pydantic models
‚îú‚îÄ‚îÄ create_promo_story_html.py # Story creation logic
‚îú‚îÄ‚îÄ post_html_story.py          # Instagram posting logic
‚îú‚îÄ‚îÄ requirements.txt            # Python dependencies
‚îú‚îÄ‚îÄ .env.example               # Example configuration
‚îú‚îÄ‚îÄ .env                       # Your configuration (gitignored)
‚îú‚îÄ‚îÄ docker-compose.yml         # Docker Compose configuration
‚îú‚îÄ‚îÄ Dockerfile                 # Docker image definition
‚îú‚îÄ‚îÄ README.md                  # This file
‚îî‚îÄ‚îÄ docs/                      # Documentation
    ‚îú‚îÄ‚îÄ architecture/          # Technical documentation
    ‚îî‚îÄ‚îÄ stories/               # Implementation stories
```

## Documentation

- [FastAPI Docs](https://fastapi.tiangolo.com/)
- [Pydantic Settings](https://docs.pydantic.dev/latest/concepts/pydantic_settings/)
- [Instagrapi Docs](https://subzeroid.github.io/instagrapi/)
- [Docker Documentation](https://docs.docker.com/)

## Contributing

Found an issue? Have a suggestion? Create an issue or submit a pull request!

## License

This project is for educational and testing purposes only.

---

**Built with ‚ù§Ô∏è using FastAPI and Instagrapi**
